<!DOCTYPE html>
<html lang="en">
<head>
    <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rickshaw/1.5.1/rickshaw.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="./lib/vendor/d3.layout.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/rickshaw/1.5.1/rickshaw.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

    <style>
    #chart_container {
            display: inline-block;
            font-family: Arial, Helvetica, sans-serif;
    }
    #chart {
            float: left;
    }
    #legend {
            float: left;
            margin-left: 15px;
    }
    #offset_form {
            float: left;
            margin: 2em 0 0 15px;
            font-size: 13px;
    }
    #y_axis {
            float: left;
            width: 40px;
    }
    </style>
</head>
<body>
<div id="chart_container">
        <div id="y_axis"></div>
        <div id="chart"></div>
        <div id="legend"></div>
        <form id="meetup_form" action="/meetup">
            <input type="text" name="name">
            <input type="submit" value="Submit">
        </form>
</div>

<script>

var data_members = [];
var series = [];


function load_single_group(json) {
  var members = [];
  $.each(json, function( key, val ) {
      members.push( {x: parseInt(key, 10), y: val }  );
  });
  return members
}

var graph = null;

function init_graph() {

    console.log("Initializing graph");

    var series = [];

    var graph = new Rickshaw.Graph( {
            element: document.querySelector("#chart"),
            width: 540,
            height: 240,
            renderer: 'line',
            series: series
    } );

    graph.palette = new Rickshaw.Color.Palette();

    var x_axis = new Rickshaw.Graph.Axis.Time( { graph: graph } );

    var y_axis = new Rickshaw.Graph.Axis.Y( {
            graph: graph,
            orientation: 'left',
            tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
            element: document.getElementById('y_axis'),
    } );

    graph.legend = new Rickshaw.Graph.Legend( {
            element: document.querySelector('#legend'),
            graph: graph
    } );


    return graph;
}

function plot_meetup(err, name, data) {

    console.log("Plotting graph for " + name);

    if (graph == null) {
        graph = init_graph();
    }

    var group_series = {
                name: name,
                data: data,
                color: graph.palette.color()
    };

    graph.series.push(group_series);
    graph.legend.addLine(group_series);

    graph.render();
}

$("#meetup_form").submit(function (e) {

    e.preventDefault();
    var form_data = $("#meetup_form").serialize();
    var values = {};
    $.each($('#meetup_form').serializeArray(), function(i, field) {
        values[field.name] = field.value;
    });

    console.log("Getting data for " + values['name'])

    $.ajax({
        url: '/meetup',
        type: 'get',
        data:  form_data,
        success: function (data) {
            var json_members = JSON.parse(data);
            plot_meetup(null, values['name'], load_single_group(json_members));
        }
    });
});
</script>
</body>
</html>